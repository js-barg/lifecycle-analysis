/**
 * Cisco Products EOL Test
 * Tests specifically Cisco products with known EOL dates
 */

const GoogleAIResearchService = require('./googleAIResearchService');
require('dotenv').config({ path: 'C:/development/lifecycle-analysis/backend/.env' });

console.log('üî∑ Cisco Products EOL Test');
console.log('‚ïê'.repeat(70));

// Cisco products with known EOL dates
const ciscoProducts = [
  {
    product_id: 'N2K-C2248TF-1GE',
    manufacturer: 'Cisco',
    type: 'Nexus 2000 Fabric Extender',
    expected: {
      eos: '2015-01-31',
      ldos: '2020-01-31',
      notes: 'Nexus 2248TF 1GE Fabric Extender'
    }
  },
  {
    product_id: 'WS-C3850-48P',
    manufacturer: 'Cisco',
    type: 'Catalyst 3850 Switch',
    expected: {
      eos: '2021-10-31',
      ldos: '2026-10-31',
      notes: 'Catalyst 3850 48-port PoE+ switch'
    }
  },
  {
    product_id: 'WS-C2960X-24PS-L',
    manufacturer: 'Cisco',
    type: 'Catalyst 2960X Switch',
    expected: {
      eos: '2021-10-31',
      ldos: '2026-10-31',
      notes: 'Catalyst 2960-X 24 port PoE switch'
    }
  },
  {
    product_id: 'WS-C3750X-48P-S',
    manufacturer: 'Cisco',
    type: 'Catalyst 3750X Switch',
    expected: {
      eos: '2018-01-30',
      ldos: '2023-01-31',
      notes: 'Catalyst 3750-X 48-port PoE switch'
    }
  },
  {
    product_id: 'N3K-C3048TP-1GE',
    manufacturer: 'Cisco',
    type: 'Nexus 3000 Switch',
    expected: {
      eos: '2015-08-02',
      ldos: '2020-08-02',
      notes: 'Nexus 3048 1GE switch'
    }
  },
  {
    product_id: 'ISR4331/K9',
    manufacturer: 'Cisco',
    type: 'ISR Router',
    expected: {
      eos: '2023-10-30',
      ldos: '2028-10-31',
      notes: 'ISR 4331 Router'
    }
  },
  {
    product_id: 'ASR1001-X',
    manufacturer: 'Cisco',
    type: 'ASR Router',
    expected: {
      eos: '2023-01-31',
      ldos: '2028-01-31',
      notes: 'ASR 1001-X Router'
    }
  },
  {
    product_id: 'AIR-CAP3702I-A-K9',
    manufacturer: 'Cisco',
    type: 'Wireless AP',
    expected: {
      eos: '2019-09-06',
      ldos: '2024-09-30',
      notes: 'Aironet 3700 Series AP'
    }
  }
];

// Results tracking
const results = [];

// Test configuration check
function checkConfiguration() {
  const apiKey = process.env.GOOGLE_API_KEY;
  const engineId = process.env.GOOGLE_SEARCH_ENGINE_ID;
  
  console.log('\nüìã Configuration Check:');
  console.log(`   API Key: ${apiKey ? '‚úÖ Configured' : '‚ùå Missing'}`);
  console.log(`   Engine ID: ${engineId ? '‚úÖ Configured' : '‚ùå Missing'}`);
  
  if (apiKey && engineId) {
    console.log(`   API Key: ${apiKey.substring(0, 10)}...`);
    console.log(`   Engine ID: ${engineId}`);
  }
  console.log('');
  
  return apiKey && engineId;
}

// Format date for display
function formatDate(dateStr) {
  if (!dateStr) return 'NOT FOUND';
  // If it's already formatted, return as is
  if (dateStr === 'NOT FOUND') return dateStr;
  // Parse and format
  try {
    const date = new Date(dateStr);
    return date.toISOString().split('T')[0];
  } catch {
    return dateStr;
  }
}

// Check if date matches expected (allowing for year match as minimum)
function checkDateMatch(found, expected) {
  if (!found || !expected) return false;
  
  const foundYear = found.substring(0, 4);
  const expectedYear = expected.substring(0, 4);
  
  if (foundYear === expectedYear) {
    // Check for exact match
    const foundFormatted = formatDate(found);
    return foundFormatted === expected ? '‚úÖ' : '‚ö†Ô∏è';
  }
  
  return '‚ùå';
}

// Test a single product
async function testCiscoProduct(product, index) {
  console.log(`${index}. Testing: ${product.product_id}`);
  console.log(`   Type: ${product.type}`);
  console.log(`   Expected: EOS ${product.expected.eos} | LDOS ${product.expected.ldos}`);
  console.log('   ' + '-'.repeat(60));
  
  const startTime = Date.now();
  
  try {
    const result = await GoogleAIResearchService.performResearch(product);
    const duration = ((Date.now() - startTime) / 1000).toFixed(1);
    
    const foundEOS = formatDate(result.end_of_sale_date);
    const foundLDOS = formatDate(result.last_day_of_support_date);
    
    const eosMatch = checkDateMatch(result.end_of_sale_date, product.expected.eos);
    const ldosMatch = checkDateMatch(result.last_day_of_support_date, product.expected.ldos);
    
    console.log(`   Found EOS:  ${foundEOS} ${eosMatch}`);
    console.log(`   Found LDOS: ${foundLDOS} ${ldosMatch}`);
    console.log(`   Confidence: ${result.lifecycle_confidence || 0}%`);
    console.log(`   Time: ${duration}s`);
    console.log(`   Sources: Vendor=${result.data_sources?.vendor_site || 0}, Third-party=${result.data_sources?.third_party || 0}`);
    
    // Track results
    results.push({
      product: product.product_id,
      type: product.type,
      success: eosMatch === '‚úÖ' || ldosMatch === '‚úÖ',
      partial: eosMatch === '‚ö†Ô∏è' || ldosMatch === '‚ö†Ô∏è',
      foundEOS: result.end_of_sale_date,
      foundLDOS: result.last_day_of_support_date,
      expectedEOS: product.expected.eos,
      expectedLDOS: product.expected.ldos,
      confidence: result.lifecycle_confidence || 0,
      duration: parseFloat(duration)
    });
    
    // Status
    if (eosMatch === '‚úÖ' && ldosMatch === '‚úÖ') {
      console.log('   ‚úÖ SUCCESS - Found correct dates');
    } else if (eosMatch === '‚úÖ' || ldosMatch === '‚úÖ') {
      console.log('   ‚ö†Ô∏è PARTIAL - Found some correct dates');
    } else if (result.end_of_sale_date || result.last_day_of_support_date) {
      console.log('   ‚ö†Ô∏è WRONG - Found dates but not matching expected');
    } else {
      console.log('   ‚ùå FAILED - No dates found');
    }
    
  } catch (error) {
    console.log(`   ‚ùå ERROR: ${error.message}`);
    results.push({
      product: product.product_id,
      type: product.type,
      success: false,
      error: true
    });
  }
  
  console.log('');
}

// Generate summary report
function generateSummary() {
  console.log('‚ïê'.repeat(70));
  console.log('üìä CISCO EOL TEST SUMMARY');
  console.log('‚ïê'.repeat(70));
  
  const total = results.length;
  const successful = results.filter(r => r.success).length;
  const partial = results.filter(r => r.partial && !r.success).length;
  const failed = results.filter(r => !r.success && !r.partial && !r.error).length;
  const errors = results.filter(r => r.error).length;
  
  console.log('\nüìà Overall Results:');
  console.log(`   Total Products: ${total}`);
  console.log(`   ‚úÖ Successful: ${successful} (${Math.round(successful/total * 100)}%)`);
  console.log(`   ‚ö†Ô∏è Partial: ${partial} (${Math.round(partial/total * 100)}%)`);
  console.log(`   ‚ùå Failed: ${failed} (${Math.round(failed/total * 100)}%)`);
  if (errors > 0) console.log(`   üî• Errors: ${errors}`);
  
  // By product type
  console.log('\nüì¶ Results by Product Type:');
  const types = [...new Set(results.map(r => r.type))];
  types.forEach(type => {
    const typeResults = results.filter(r => r.type === type);
    const typeSuccess = typeResults.filter(r => r.success).length;
    console.log(`   ${type}: ${typeSuccess}/${typeResults.length} successful`);
  });
  
  // Performance
  const avgTime = results
    .filter(r => r.duration)
    .reduce((sum, r) => sum + r.duration, 0) / (total - errors);
  console.log(`\n‚è±Ô∏è Average Search Time: ${avgTime.toFixed(1)}s per product`);
  
  // Problem products
  const problems = results.filter(r => !r.success && !r.error);
  if (problems.length > 0) {
    console.log('\n‚ö†Ô∏è Products Needing Attention:');
    problems.forEach(r => {
      console.log(`   ‚Ä¢ ${r.product} (${r.type})`);
      if (r.foundEOS || r.foundLDOS) {
        console.log(`     Found: EOS ${r.foundEOS || 'none'}, LDOS ${r.foundLDOS || 'none'}`);
        console.log(`     Expected: EOS ${r.expectedEOS}, LDOS ${r.expectedLDOS}`);
      } else {
        console.log(`     No dates found - check search queries`);
      }
    });
  }
  
  // Recommendations
  if (successful < total) {
    console.log('\nüí° Recommendations for Cisco Products:');
    console.log('   1. Add specific bulletin URLs: site:cisco.com/c/en/us/products/eos-eol-notice-listing.html');
    console.log('   2. Handle Cisco date format: 31-Jan-2015');
    console.log('   3. Search for PDF bulletins: filetype:pdf');
    console.log('   4. Extract dates from tables in EOL notices');
    console.log('   5. Increase context radius for date extraction');
  } else {
    console.log('\n‚úÖ Excellent! All Cisco products found successfully!');
  }
  
  console.log('');
}

// Main test runner
async function runCiscoTest() {
  console.log('üìÖ Test Date:', new Date().toLocaleString());
  console.log(`üì¶ Testing ${ciscoProducts.length} Cisco products\n`);
  
  // Check configuration
  const configured = checkConfiguration();
  if (!configured) {
    console.log('‚ö†Ô∏è Warning: Google API not properly configured\n');
  }
  
  console.log('‚ïê'.repeat(70));
  console.log('Starting Cisco product tests...\n');
  
  // Test each product
  for (let i = 0; i < ciscoProducts.length; i++) {
    await testCiscoProduct(ciscoProducts[i], i + 1);
    
    // Delay between tests to avoid rate limiting
    if (i < ciscoProducts.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 500));
    }
  }
  
  // Generate summary
  generateSummary();
  
  console.log('‚ïê'.repeat(70));
  console.log('‚úÖ Cisco Test Complete!');
  console.log('‚ïê'.repeat(70));
}

// Run the test
runCiscoTest().catch(console.error);